---
title: "Heterogeneity in HCV response at the single cell level"
author: "Health Data Science Unit"
date: "`r date()`"
output: 
    html_document:
            code_folding: hide
---

```{r setup, include=FALSE}
library(Matrix)
library(dplyr)
library(uwot)
library(ggplot2)
library(GEOquery)
library(Seurat)
source('../scripts//pipeline.R')

knitr::opts_chunk$set(warning = FALSE,
                      message = FALSE,
                      cache = TRUE,
                      fig.width = 10,
                      fig.height = 7, 
                      echo = FALSE,
                      cache.lazy = FALSE)
```



## Satpathy AT data

```{r satpathy_loading}
## barcodes
summaryTCells <- readRDS('../data/satpathy2016/scATAC_TME_TCells_SummarizedExperiment.final.rds')
```

## Provided visualization

```{r data_vis, fig.height=7, fig.width=10}
tcells_ann <- data.frame('UMAP1'=summaryTCells$UMAP1,
                         'UMAP2'=summaryTCells$UMAP2,
                         'Clusters'=summaryTCells$T_Cell_Cluster)
ggplot(data = tcells_ann) +
        geom_point(aes(UMAP1, UMAP2, colour=Clusters), alpha=0.3, size=0.5) + theme_bw()
```


```{r}
activity_matrix <- readRDS('../data/satpathy2016/activity_matrix.RDS')
atac <- CreateSeuratObject(
        counts = activity_matrix,
        assay = 'ATAC',
        project = 'atac'
)
## Adding estimated gene activity matrix
atac[['activity']] <- CreateAssayObject(
        counts = activity_matrix
)
DefaultAssay(atac) <- 'activity'
atac <- AddMetaData(atac, metadata = tcells_ann)
atac$'tech' <- 'ATAC'
atac <- NormalizeData(atac)
atac <- ScaleData(atac)
DefaultAssay(atac) <- "ATAC"
VariableFeatures(atac) <- names(which(Matrix::rowSums(atac) > 100))
atac <- RunLSI(atac, n = 50, scale.max = NULL)
atac <- RunUMAP(atac, reduction = "lsi", dims = 1:50)
```

```{r}
atac$orig.ident <- tcells_ann$Clusters
atac.vis <- DimPlot(atac, group.by = 'orig.ident', reduction = 'umap', label = TRUE) + NoLegend() + ggtitle('ATAC')
```

## Miller 2019

```{r seurat_object}
rna_lcmv <- Read10X('../data/miller2019_upper_Case/')
rna <- CreateSeuratObject(counts = rna_lcmv, project = 'lcmv', assay = 'rna', min.cells = 1, min.features = 200)
```

```{r standard_preprocessing}
rna <- NormalizeData(rna)
rna <- FindVariableFeatures(rna, selection.method = 'vst', nfeatures = 3000)
rna <- ScaleData(rna, verbose = FALSE)
rna <- RunPCA(rna, npcs = 30, verbose = FALSE)
rna <- RunUMAP(rna, reduction = "pca", dims = 1:30)
rna <- FindNeighbors(rna, dims = 1:30, verbose = FALSE)
rna <- FindClusters(rna, resolution= 0.1, verbose = FALSE)
```


```{r vis}
rna$orig.ident <- rna$seurat_clusters
rna.vis <- DimPlot(rna, reduction = 'umap', group.by = 'seurat_clusters', label = TRUE) + NoLegend() + ggtitle('RNA')
```

```{r comb_plot}
CombinePlots(plots = list(rna.vis, atac.vis))
```

```{r saving_processed_data}
saveRDS(rna, '../data/rna_seurat_processed_miller2019.rds')
saveRDS(atac, '../data/atac_seurat_processed_miller2019.rds')
```

```{r eval=FALSE}
transfer.anchors <- FindTransferAnchors(reference = rna, 
                                        query = atac, 
                                        features = VariableFeatures(object = pbmc.rna), 
                                        reference.assay = "rna", 
                                        query.assay = "activity", 
                                        reduction = "cca")
```

```{r}
transfer.anchors <- readRDS('../data/transfer.anchors.rds')
```


```{r}
celltype.predictions <- TransferData(anchorset = transfer.anchors, 
                                     refdata = rna$orig.ident, 
                                     weight.reduction = atac[["lsi"]])
atac <- AddMetaData(atac, metadata = celltype.predictions)
```

```{r}
hist(atac$prediction.score.max)
table(atac$prediction.score.max > 0.02)
atac.filtered <- subset(atac, subset = prediction.score.max > 0.5)
atac.filtered$predicted.id <- factor(atac.filtered$predicted.id, levels = levels(rna))
DimPlot(atac.filtered, group.by = 'predicted.id', label = TRUE)
```

```{r eval=FALSE}
genes.use <- VariableFeatures(rna)
refdata <- GetAssayData(rna, assay = "rna", slot = "data")[genes.use, ]
imputation <- TransferData(anchorset = transfer.anchors, 
                           refdata = refdata, 
                           weight.reduction = atac[["lsi"]])
atac[["RNA"]] <- imputation
coembed <- merge(x = rna, y = atac)
coembed <- NormalizeData(coembed)
coembed <- ScaleData(coembed, features = genes.use, do.scale = FALSE)
coembed <- RunPCA(coembed, features = genes.use, verbose = FALSE)
coembed <- RunUMAP(coembed, dims = 1:50)
DimPlot(coembed, group.by = 'orig.ident', reduction = 'umap')
```
