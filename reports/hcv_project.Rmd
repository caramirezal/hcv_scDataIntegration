---
title: "Heterogeneity in HCV response at the single cell level"
author: "Health Data Science Unit"
date: "`r date()`"
output: 
    html_document:
            code_folding: hide
---

```{r setup, include=FALSE}
library(Matrix)
library(dplyr)
library(uwot)
library(ggplot2)
library(GEOquery)
library(Seurat)
source('../scripts//pipeline.R')

knitr::opts_chunk$set(warning = FALSE,
                      message = FALSE,
                      cache = TRUE,
                      fig.width = 10,
                      fig.height = 7, 
                      echo = FALSE,
                      cache.lazy = FALSE)
```



## Satpathy AT data

```{r satpathy_loading}
## barcodes
summaryTCells <- readRDS('../data/satpathy2016/scATAC_TME_TCells_SummarizedExperiment.final.rds')
```


```{r create_annotations}
t_cell_clust <- summaryTCells$T_Cell_Cluster
cluster_labs <- paste0('Cluster', 1:19)        
cell_type <- c('1-Naive CD4 T', '2-Activated CD4', '3-Th1', '4-Memory CD4 T',
               '5-Th17', '6-Th 1', '7-Th 2', '8-Treg 1',
               '9-Treg 2', '10-Treg 3', '11-Treg 4', '12-Effector CD8 T',
               '13-Naive CD8 T', '14-Memory CD8 T', '15-Early TEx', '16-Intermediate TEx',
               '17-Terminal TEx', '18-Other T', '19-Other T')
cluster_cell_types <- plyr::mapvalues(t_cell_clust, 
                                      from = cluster_labs, 
                                      to = cell_type)
```




```{r}
activity_matrix <- readRDS('../data/satpathy2016/activity_matrix.RDS')
atac <- CreateSeuratObject(
        counts = activity_matrix,
        assay = 'ATAC',
        project = 'atac'
)
## Adding estimated gene activity matrix
atac[['activity']] <- CreateAssayObject(
        counts = activity_matrix
)
DefaultAssay(atac) <- 'activity'
atac$orig.ident <- cluster_cell_types
atac$'tech' <- 'ATAC'
atac <- NormalizeData(atac)
atac <- ScaleData(atac)
DefaultAssay(atac) <- "ATAC"
VariableFeatures(atac) <- names(which(Matrix::rowSums(atac) > 100))
atac <- RunLSI(atac, n = 50, scale.max = NULL)
atac <- RunUMAP(atac, reduction = "lsi", dims = 1:50)
```

```{r atac_vis}
DefaultAssay(atac) <- 'activity'
atac.vis <- DimPlot(atac, group.by = 'orig.ident', reduction = 'umap', label = TRUE) + NoLegend() + ggtitle('ATAC')
```


```{r seurat_object}
rna_lcmv <- Read10X('../data/miller2019_upper_Case/')
rna <- CreateSeuratObject(counts = rna_lcmv, project = 'lcmv', assay = 'rna', min.cells = 1, min.features = 200)
```

```{r standard_preprocessing}
rna <- NormalizeData(rna)
rna <- FindVariableFeatures(rna, selection.method = 'vst', nfeatures = 3000)
rna <- ScaleData(rna, verbose = FALSE)
rna <- RunPCA(rna, npcs = 30, verbose = FALSE)
rna <- RunUMAP(rna, reduction = "pca", dims = 1:30)
rna <- FindNeighbors(rna, dims = 1:30, verbose = FALSE)
rna <- FindClusters(rna, resolution= 0.1, verbose = FALSE)
```



```{r annotate_clusters}
rna$orig.ident <- rna$seurat_clusters
rna_ann <- data.frame('cluster' = rna$orig.ident,
                      'cell_type' = plyr::mapvalues(x = rna$orig.ident,
                                                    from = as.factor(c(3,0,4,2,1)), 
                                                    to = c('Proliferating', 'Effector', 'Naive',
                                                           'Progenitor Ex', 'Terminally Ex')
                                                    )
)
rna <- AddMetaData(rna, metadata = rna_ann)
rna$orig.ident <- rna$cell_type
saveRDS(rna_ann, '../data/rna_annotations_miller2019.rds')
rna.vis <- DimPlot(rna, group.by = 'cell_type', reduction = 'umap', label = TRUE) + NoLegend() + ggtitle('RNA')
```

```{r comb_plot}
CombinePlots(plots = list(rna.vis, atac.vis))
```

```{r saving_processed_data, eval=FALSE}
saveRDS(rna, '../data/rna_seurat_processed_miller2019.rds')
saveRDS(atac, '../data/atac_seurat_processed_miller2019.rds')
```

```{r eval=FALSE}
transfer.anchors <- FindTransferAnchors(reference = rna, 
                                        query = atac, 
                                        features = VariableFeatures(object = pbmc.rna), 
                                        reference.assay = "rna", 
                                        query.assay = "activity", 
                                        reduction = "cca")
```

```{r}
transfer.anchors <- readRDS('../data/transfer.anchors.rds')
```

```{r rna_annotations, eval=FALSE}
```

```{r}
celltype.predictions <- TransferData(anchorset = transfer.anchors, 
                                     refdata = rna$orig.ident, 
                                     weight.reduction = atac[["lsi"]])
atac <- AddMetaData(atac, metadata = celltype.predictions)
```

```{r}
#hist(atac$prediction.score.max)
#table(atac$prediction.score.max > 0.02)
atac.filtered <- subset(atac, subset = prediction.score.max > 0.005)
#atac.filtered$predicted.id <- factor(atac.filtered$predicted.id, levels = levels(rna))
DimPlot(atac.filtered, group.by = 'predicted.id', label = TRUE)
```

```{r eval=FALSE}
genes.use <- VariableFeatures(rna)
refdata <- GetAssayData(rna, assay = "rna", slot = "data")[genes.use, ]
imputation <- TransferData(anchorset = transfer.anchors, 
                           refdata = refdata, 
                           weight.reduction = atac[["lsi"]])
atac[["RNA"]] <- imputation
coembed <- merge(x = rna, y = atac)
coembed <- NormalizeData(coembed)
coembed <- ScaleData(coembed, features = genes.use, do.scale = FALSE)
coembed <- RunPCA(coembed, features = genes.use, verbose = FALSE)
coembed <- RunUMAP(coembed, dims = 1:50)
DimPlot(coembed, group.by = 'orig.ident', reduction = 'umap')
```


